<%-include("header-main")-%>

    <header>
      <nav id="main-nav" class="container navbar navbar-dark navbar-expand-lg">
        <div class="container-fluid">
          <a id="b-title" class="sel-nav" href="/">
            <img
              id="berry"
              src="/blockberry-logo-white.png"
              
              class="d-inline-block align-text-top"
            />
            </a
          >

          <div class="nav justify-content-end" id="navbarText">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              
              <li class="nav-item">
                <a class="nav-link" href="#"><%=user.name %></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/logout">Log out</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <nav class="container">
        <p>Latest News Updates <span>(Powered by newsdata.io)</span></p>
        <ul class="list-group"></ul>
      </nav>
      <nav id="nav-pad" class="container navbar navbar-dark">
        <div class="container justify-content-space-between">
          <span class="justify-content-start" id="date"></span>
          <form id="search-tokens"class="d-flex" role="search">
            <input
              id="param"
              class="form-control me-2"
              type="search"
              placeholder="Search token name.."
              aria-label="Search"
            />
            <button for="param" class="btn btn-primary" type="submit">Search</button>
          </form>
        </div>
      </nav>
    </header>
    <main>
      <section class="asset-list container">
        <table class="table-body table table-dark table-hover table-lg">
          <thead>
            <tr>
              <td>#</td>
              <td>Name</td>
              <td>Price</td>
              <td>24h%</td>
              <td>ATH</td>
              <td>Marketcap</td>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
      <section class="news-column">
        <ul class="news-list"></ul>
      </section>
    </main>

    <script>

      //Fetch asset prices from Coingecko
fetch(
    "https://api.coingecko.com/api/v3/coins/markets?vs_currency=gbp&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h"
  )
    .then((data) => {
      return data.json(); // Convert Promsie to an Object
    })
    .then((objectData) => {
      let tableData = "";
      //Iterate through object and append data to table
      objectData.map((values) => {
        tableData += `<tr>
        <td>${values.market_cap_rank}</td>
        <td><img src="${values.image}">  ${values.name}</td>
        <td>£${values.current_price.toLocaleString("en-US")}</td>
        <td class="text-success">${parseFloat(values.price_change_percentage_24h).toFixed(2)}%</td>
        <td>£${parseFloat(values.ath).toFixed(2).toLocaleString("en-US")}</td>
        <td>£${values.market_cap.toLocaleString("en-US")}</td>
        </tr>`;
      });
  
      document.querySelector("tbody").innerHTML = tableData;
    })
    .then(() => {
      //Check for negative value
      const pCheck = document.querySelectorAll(".text-success");
      for (let i = 0; i < pCheck.length; i++) {
        if (pCheck[i].innerHTML.includes("-")) {
          pCheck[i].className = "text-danger";
        }
      }
    });
  
  //Get time
  const date = new Date();
  document.getElementById("date").innerHTML = date.toGMTString();
  
  
  fetch(
    "https://newsdata.io/api/1/news?apikey=pub_1186204cddda4e3240053ffd74370bde06bf1&q=cryptocurrency&country=gb&language=en&category=business,technology,world "
  )
    .then((data) => {
      return data.json();
    })
    .then((objectData) => {
      listData = "";
      // console.log(objectData.results);
      objectData.results.map((values) => {
 
        listData += `<li id="li-news" class="list-group-item list-group-item-action list-group-item-light"><a href='${values.link}'>${values.title}</a></li>`;
      });
  
      // console.log(listData);
  
      document.querySelector(".list-group").innerHTML = listData;
    });
  
  //EVENT LISTENER TO SUBMIT INPUT AND FETCH COIN GECKO API
  const searchTokens = document.querySelector("#search-tokens");
  searchTokens.addEventListener("submit", (e) => {
    //
    const param = document.getElementById("param").value;
    fetch(
      `https://api.coingecko.com/api/v3/coins/markets?vs_currency=gbp&ids=${param.toLowerCase()}&order=market_cap_desc&per_page=100&page=1&sparkline=false`
    )
      .then((data) => {
        return data.json();
      })
      .then((objectData) => {
        objectData.map((values) => {
          let tableData = "";
          //Iterate through object and append data to table
          objectData.map((values) => {
            tableData += `<tr>
        <td>${values.market_cap_rank}</td>
        <td><img src="${values.image}">  ${values.name}</td>
        <td>£${values.current_price.toLocaleString("en-US")}</td>
        <td class="text-success">${parseFloat(values.price_change_percentage_24h).toFixed(2)}%</td>
        <td>£${parseFloat(values.ath).toFixed(2).toLocaleString("en-US")}</td>
        <td>£${values.market_cap.toLocaleString("en-US")}</td>
        </tr>`;
          });
          console.log(tableData)
          document.querySelector("tbody").innerHTML = tableData;
        });
      }).then(() => {
      //Check for negative value
      const pCheck = document.querySelectorAll(".text-success");
      for (let i = 0; i < pCheck.length; i++) {
        if (pCheck[i].innerHTML.includes("-")) {
          pCheck[i].className = "text-danger";
        }
      }
    });
    e.preventDefault();
  });
  

    </script>
    <footer class="container">
    <div class="foot">
      Powered by CoinGecko
      <img id = "gecko" src="/coingecko_logo_without_text.png" />
    </div>
  </footer>


<%-include("footer")-%>